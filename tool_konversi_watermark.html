<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF/Image Utility - Candra</title>
    <!-- Memuat Tailwind CSS untuk Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Mengatur font default */
        html { font-family: 'Inter', sans-serif; }
        
        /* Gaya untuk area Drag & Drop */
        #drop-area {
            border: 4px dashed #6b7280; /* netral 500 */
            transition: all 0.2s;
            cursor: pointer;
        }
        #drop-area.drag-over {
            border-color: #3b82f6; /* biru 500 */
            background-color: #1e293b; /* slate 800 */
        }
    </style>
    <!-- Pustaka PDF.js untuk merender PDF ke Canvas (konversi ke gambar) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.worker.min.js"></script>
    <!-- Pustaka PDF-lib untuk memanipulasi dan memberi watermark pada PDF -->
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 sm:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-blue-400">PDF & Image Utility</h1>
            <p class="text-gray-400 mt-2">Konversi PDF ke Gambar dan Watermark (Client-Side)</p>
        </header>

        <!-- Area Drop File -->
        <div id="drop-area" class="flex flex-col items-center justify-center p-12 rounded-xl bg-gray-800 shadow-xl mb-8">
            <svg class="w-12 h-12 text-blue-500 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.882 3.097A4 4 0 014 20h16a4 4 0 001.992-3.633.992.992 0 00-.002-.127l-2.58-12.9A2 2 0 0016.5 2H7.5a2 2 0 00-1.99 2.01l-2.58 12.9a.992.992 0 00-.002.127z"></path></svg>
            <p class="text-lg font-semibold text-gray-300">Tarik & Lepaskan File di Sini</p>
            <p class="text-sm text-gray-500 mt-1">atau</p>
            <button onclick="document.getElementById('file-input').click()" class="mt-3 px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg shadow-md transition duration-150">Pilih File</button>
            <input type="file" id="file-input" class="hidden" accept=".pdf, image/jpeg, image/png">
            <p class="text-xs text-gray-500 mt-3">Mendukung: PDF, JPG, PNG</p>
        </div>

        <!-- Kontrol Watermark -->
        <div class="bg-gray-800 p-6 rounded-xl shadow-xl mb-8">
            <h2 class="text-2xl font-bold mb-4 text-gray-200">Pengaturan Watermark</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="text" id="watermark-text" placeholder="Teks Watermark (e.g. RAHASIA)" value="DOKUMEN CONTOH"
                       class="col-span-2 p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-white">
                <select id="watermark-type" class="p-3 bg-gray-700 border border-gray-600 rounded-lg text-white">
                    <option value="diagonal">Diagonal</option>
                    <option value="center">Pusat</option>
                </select>
            </div>
            <div class="mt-4 flex flex-col sm:flex-row gap-4">
                <button id="convert-btn" class="flex-1 px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition duration-150 disabled:bg-green-800" disabled>
                    Konversi PDF ke Gambar (PNG)
                </button>
                <button id="watermark-btn" class="flex-1 px-4 py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg transition duration-150 disabled:bg-purple-800" disabled>
                    Terapkan Watermark
                </button>
            </div>
        </div>

        <!-- Status dan Hasil -->
        <div id="status-message" class="hidden p-4 mb-8 bg-blue-900 text-blue-200 rounded-lg text-center font-medium">
            Memuat...
        </div>

        <div id="output-area" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Canvas dan Gambar Hasil akan dimasukkan di sini -->
        </div>
    </div>

    <script>
        // Set worker source untuk pdf.js
        if (window.pdfjsLib) {
            window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.worker.min.js';
        }

        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');
        const outputArea = document.getElementById('output-area');
        const watermarkText = document.getElementById('watermark-text');
        const watermarkType = document.getElementById('watermark-type');
        const convertBtn = document.getElementById('convert-btn');
        const watermarkBtn = document.getElementById('watermark-btn');
        const statusMessage = document.getElementById('status-message');

        let currentFile = null;
        let currentFileType = null; // 'pdf' atau 'image'

        // --- Fungsi Utilitas UI ---

        function showStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.className = `p-4 mb-8 rounded-lg text-center font-medium ${isError ? 'bg-red-900 text-red-200' : 'bg-blue-900 text-blue-200'}`;
            statusMessage.classList.remove('hidden');
        }

        function hideStatus() {
            statusMessage.classList.add('hidden');
        }

        function setButtonsState(file) {
            if (!file) {
                currentFile = null;
                currentFileType = null;
                convertBtn.disabled = true;
                watermarkBtn.disabled = true;
                convertBtn.textContent = 'Konversi PDF ke Gambar (PNG)';
                watermarkBtn.textContent = 'Terapkan Watermark';
                return;
            }

            currentFile = file;
            const mime = file.type;

            if (mime === 'application/pdf') {
                currentFileType = 'pdf';
                convertBtn.disabled = false;
                watermarkBtn.disabled = false;
                convertBtn.textContent = 'Konversi PDF ke Gambar (PNG)';
                watermarkBtn.textContent = 'Terapkan Watermark ke PDF';
            } else if (mime.startsWith('image/')) {
                currentFileType = 'image';
                convertBtn.disabled = true; // Konversi gambar tidak relevan
                watermarkBtn.disabled = false;
                convertBtn.textContent = 'Tidak Relevan untuk Gambar';
                watermarkBtn.textContent = 'Terapkan Watermark ke Gambar';
            } else {
                showStatus('Jenis file tidak didukung: ' + mime, true);
                setButtonsState(null);
            }
        }
        
        // --- Fungsi Konversi PDF ke Gambar ---

        async function convertPdfToImages(file) {
            if (currentFileType !== 'pdf') return;

            showStatus('Memproses: Mengkonversi PDF ke PNG...');
            outputArea.innerHTML = '';
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdfDoc = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                const numPages = pdfDoc.numPages;

                for (let i = 1; i <= numPages; i++) {
                    const page = await pdfDoc.getPage(i);
                    const viewport = page.getViewport({ scale: 1.5 }); // Skala 1.5 untuk resolusi yang lebih baik

                    // Buat Canvas untuk setiap halaman
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    const renderContext = {
                        canvasContext: context,
                        viewport: viewport
                    };
                    
                    await page.render(renderContext).promise;

                    // Konversi Canvas ke PNG/JPG
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'bg-gray-800 p-4 rounded-xl shadow-lg';
                    imgContainer.innerHTML = `
                        <h3 class="text-lg font-semibold mb-2 text-gray-300">Halaman ${i}</h3>
                    `;

                    // Konversi ke format yang diminta
                    const format = 'image/png'; // Default ke PNG
                    const dataUrl = canvas.toDataURL(format);

                    const img = document.createElement('img');
                    img.src = dataUrl;
                    img.className = 'w-full h-auto rounded-lg border border-gray-700';
                    imgContainer.appendChild(img);

                    // Tombol Download
                    const downloadLink = document.createElement('a');
                    downloadLink.href = dataUrl;
                    downloadLink.download = `${file.name.replace('.pdf', '')}_halaman_${i}.png`;
                    downloadLink.className = 'mt-3 inline-block w-full text-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition duration-150';
                    downloadLink.textContent = `Unduh Halaman ${i} (PNG)`;
                    imgContainer.appendChild(downloadLink);

                    outputArea.appendChild(imgContainer);
                }

                showStatus(`Konversi ${numPages} halaman PDF selesai.`, false);
            } catch (error) {
                console.error('Error saat konversi PDF:', error);
                showStatus('Gagal mengkonversi PDF. ' + error.message, true);
            }
        }
        
        // --- Fungsi Watermarking Gambar ---

        function applyWatermarkToImage(file) {
            if (currentFileType !== 'image') return;

            showStatus('Memproses: Menerapkan Watermark ke Gambar...');
            outputArea.innerHTML = '';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        
                        // 1. Gambar Gambar Asli
                        ctx.drawImage(img, 0, 0);

                        // 2. Persiapan Watermark
                        const text = watermarkText.value.toUpperCase();
                        const type = watermarkType.value;
                        
                        // Pengaturan Teks
                        ctx.fillStyle = 'rgba(255, 255, 255, 0.4)'; // Putih, 40% opacity
                        ctx.font = `${Math.floor(img.width / 15)}px sans-serif`; 
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';

                        if (type === 'diagonal') {
                            // Gaya Diagonal: Putar dan ulangi
                            ctx.translate(img.width / 2, img.height / 2);
                            ctx.rotate(-Math.PI / 4); // Putar 45 derajat
                            
                            // Ulangi teks secara diagonal
                            const patternSize = 300; // Jarak antar teks
                            for (let i = -img.width; i < img.width * 2; i += patternSize) {
                                for (let j = -img.height; j < img.height * 2; j += patternSize) {
                                    ctx.fillText(text, i, j);
                                }
                            }
                            // Kembalikan transformasi
                            ctx.setTransform(1, 0, 0, 1, 0, 0); 
                        } else {
                            // Gaya Tengah: Cukup di tengah
                            ctx.fillText(text, img.width / 2, img.height / 2);
                        }

                        // 3. Tampilkan dan Sediakan Download
                        const format = file.type === 'image/jpeg' ? 'image/jpeg' : 'image/png';
                        const extension = file.type === 'image/jpeg' ? 'jpg' : 'png';
                        const dataUrl = canvas.toDataURL(format);

                        const resultContainer = document.createElement('div');
                        resultContainer.className = 'md:col-span-2 bg-gray-800 p-4 rounded-xl shadow-lg text-center';
                        resultContainer.innerHTML = `
                            <h3 class="text-xl font-semibold mb-3 text-gray-300">Hasil Watermark</h3>
                            <img src="${dataUrl}" class="w-full h-auto rounded-lg border border-gray-700 mb-4 mx-auto max-w-lg">
                        `;

                        const downloadLink = document.createElement('a');
                        downloadLink.href = dataUrl;
                        downloadLink.download = `${file.name.replace(`.${extension}`, '')}_watermarked.${extension}`;
                        downloadLink.className = 'mt-3 inline-block px-8 py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg transition duration-150';
                        downloadLink.textContent = `Unduh File Watermarked (${extension.toUpperCase()})`;
                        resultContainer.appendChild(downloadLink);
                        
                        outputArea.appendChild(resultContainer);
                        showStatus('Watermark gambar selesai.', false);
                    };
                    img.src = e.target.result;
                } catch (error) {
                    console.error('Error saat watermark gambar:', error);
                    showStatus('Gagal menerapkan watermark pada gambar. ' + error.message, true);
                }
            };
            reader.readAsDataURL(file);
        }

        // --- Fungsi Watermarking PDF ---

        async function applyWatermarkToPdf(file) {
            if (currentFileType !== 'pdf') return;

            showStatus('Memproses: Menerapkan Watermark ke PDF. Harap tunggu...');
            outputArea.innerHTML = '';
            
            try {
                const { PDFDocument, rgb, degrees } = window.PDFLib;
                const existingPdfBytes = await file.arrayBuffer();
                const pdfDoc = await PDFDocument.load(existingPdfBytes);

                const text = watermarkText.value.toUpperCase();
                const type = watermarkType.value;
                const pages = pdfDoc.getPages();
                
                // Mendapatkan font yang akan digunakan
                const font = await pdfDoc.embedFont(window.PDFLib.StandardFonts.HelveticaBold);
                const fontSize = 72; // Ukuran font besar
                const color = rgb(0.5, 0.5, 0.5); // Abu-abu
                const opacity = 0.1; // Sangat transparan (10% opacity)
                
                for (const page of pages) {
                    const { width, height } = page.getSize();
                    const textWidth = font.widthOfTextAtSize(text, fontSize);

                    if (type === 'diagonal') {
                        const diagonalAngle = degrees(-45); // Putar -45 derajat
                        const repeatInterval = 300; // Jarak antar teks

                        // Tiling loop untuk diagonal watermark
                        for (let x = -width; x < width * 2; x += repeatInterval) {
                            for (let y = -height; y < height * 2; y += repeatInterval) {
                                page.drawText(text, {
                                    x: x,
                                    y: y,
                                    size: fontSize,
                                    font: font,
                                    color: color,
                                    rotate: diagonalAngle,
                                    opacity: opacity,
                                });
                            }
                        }

                    } else {
                        // Penempatan di tengah
                        page.drawText(text, {
                            x: (width / 2) - (textWidth / 2),
                            y: (height / 2) - (fontSize / 2),
                            size: fontSize,
                            font: font,
                            color: color,
                            opacity: opacity,
                        });
                    }
                }

                // Simpan PDF baru
                const pdfBytes = await pdfDoc.save();
                
                // Tampilkan hasil dan tombol download
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);

                const resultContainer = document.createElement('div');
                resultContainer.className = 'md:col-span-2 bg-gray-800 p-4 rounded-xl shadow-lg text-center';
                resultContainer.innerHTML = `
                    <h3 class="text-xl font-semibold mb-3 text-gray-300">PDF Watermarked Selesai</h3>
                `;

                // Tombol Download
                const downloadLink = document.createElement('a');
                downloadLink.href = url;
                downloadLink.download = `${file.name.replace('.pdf', '')}_watermarked.pdf`;
                downloadLink.className = 'mt-3 inline-block px-8 py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg transition duration-150';
                downloadLink.textContent = 'Unduh PDF Watermarked';
                resultContainer.appendChild(downloadLink);
                
                // Opsional: Tampilkan link pratinjau (tidak berfungsi di semua iframe/browser)
                const previewLink = document.createElement('a');
                previewLink.href = url;
                previewLink.target = '_blank';
                previewLink.className = 'mt-3 ml-4 inline-block px-4 py-3 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg transition duration-150';
                previewLink.textContent = 'Buka Pratinjau (Tab Baru)';
                resultContainer.appendChild(previewLink);

                outputArea.appendChild(resultContainer);

                showStatus('Watermark PDF selesai. File siap diunduh.', false);
            } catch (error) {
                console.error('Error saat watermark PDF:', error);
                showStatus('Gagal menerapkan watermark pada PDF. ' + error.message, true);
            }
        }


        // --- Event Handlers ---

        function handleFile(file) {
            outputArea.innerHTML = ''; // Bersihkan hasil sebelumnya
            setButtonsState(file);
            showStatus(`File "${file.name}" dimuat. Pilih aksi.`);
        }

        // Listener Drag & Drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => {
                dropArea.classList.add('drag-over');
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => {
                dropArea.classList.remove('drag-over');
            }, false);
        });

        dropArea.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }, false);
        
        // Listener Input File
        fileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });
        
        // Listener Paste (Optional: untuk teks/screenshot, tapi di sini fokus ke file)
        // Untuk mengimplementasikan Paste File, diperlukan logic tambahan. Kita fokus pada Drag/Upload dulu.

        // Listener Tombol
        convertBtn.addEventListener('click', () => {
            if (currentFile) {
                convertPdfToImages(currentFile);
            }
        });

        watermarkBtn.addEventListener('click', () => {
            if (!currentFile) return;

            if (currentFileType === 'pdf') {
                applyWatermarkToPdf(currentFile);
            } else if (currentFileType === 'image') {
                applyWatermarkToImage(currentFile);
            }
        });

        // Inisialisasi awal
        setButtonsState(null);
    </script>
</body>
</html>
