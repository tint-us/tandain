<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tandain — Watermark Gambar & PDF</title>
    
    <!-- Load Tailwind CSS (Main Framework) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        primary: '#2563eb',
                        secondary: '#0f172a'
                    }
                }
            }
        }
    </script>
    
    <!-- Load PDF Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom CSS from Image Tool (Scoped & Adapted) -->
    <style>
        /* Variabel CSS asli dari watermark-image.html, di-scope agar tidak merusak layout utama */
        .img-tool-theme {
            --bg:#f7f9fc; --ink:#0f172a; --muted:#5b6b8b; --card:#ffffff; --line:#e6eaf2;
            --primary:#2563eb; --primary-ink:#ffffff; --accent:#0ea5e9; --surface:#eef2f7;
            --highlight-bg:#ecfccb; --highlight-ink:#365314;
        }
        
        /* Utility Classes khusus Image Tool */
        .it-panel { background:var(--card); border:1px solid var(--line); border-radius:14px; }
        .it-drop { border:2px dashed var(--line); border-radius:14px; padding:18px; text-align:center; background:var(--surface); transition: all 0.2s; }
        .it-drop.drag { border-color:var(--primary); background: #e0f2fe; }
        
        /* Canvas preview styling */
        canvas.img-canvas-preview { width:100%; height:auto; background: repeating-conic-gradient(#80808022 0% 25%, transparent 0% 50%) 50% / 20px 20px; border-radius:12px; display:block; border: 1px solid var(--line); }
        
        /* PDF Preview Area Styling to match Image Canvas */
        #pdf-preview-area {
            width: 100%;
            min-height: 300px;
            max-height: 500px;
            overflow-y: auto;
            background: repeating-conic-gradient(#80808022 0% 25%, transparent 0% 50%) 50% / 20px 20px;
            border-radius: 12px;
            border: 1px solid var(--line);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            padding: 1rem;
        }
        #pdf-preview-area canvas {
            max-width: 100%;
            height: auto;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-radius: 4px;
        }

        /* Styling Input Number agar terlihat modern */
        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { 
            opacity: 1; 
        }
        
        /* Tab Active State */
        .tab-btn.active {
            border-bottom: 2px solid #2563eb;
            color: #2563eb;
            font-weight: 600;
        }
        .tab-btn {
            color: #64748b;
            font-weight: 500;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen flex flex-col">

    <!-- HEADER & TABS -->
    <header class="bg-white shadow-sm sticky top-0 z-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-600 to-cyan-500 flex items-center justify-center text-white font-bold text-lg">T</div>
                    <span class="font-bold text-gray-800 text-xl tracking-tight">Tandain</span>
                </div>
            </div>
            
            <!-- Tab Navigation -->
            <div class="flex space-x-8 -mb-px overflow-x-auto">
                <button onclick="switchTab('image')" id="tab-btn-image" class="tab-btn active py-4 px-1 text-sm transition-colors duration-200">
                    Image Watermark
                </button>
                <button onclick="switchTab('pdf')" id="tab-btn-pdf" class="tab-btn py-4 px-1 text-sm transition-colors duration-200">
                    PDF Watermark
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- ========================================== -->
        <!-- TAB 1: IMAGE WATERMARK CONTENT             -->
        <!-- ========================================== -->
        <div id="tab-content-image" class="img-tool-theme grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- LEFT PANEL: PREVIEW -->
            <section class="it-panel p-0 overflow-hidden shadow-sm h-fit">
                <div class="px-4 py-3 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                    <h2 class="font-semibold text-gray-700">Pratinjau Gambar</h2>
                    <span id="img-meta" class="text-xs text-gray-500"></span>
                </div>
                <div class="p-4">
                    <div id="img-drop" class="it-drop cursor-pointer hover:bg-gray-100">
                        <svg class="w-10 h-10 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        <p class="text-sm text-gray-600">Klik atau drop gambar di sini</p>
                        <input id="img-file" type="file" accept="image/*" hidden />
                    </div>
                    <div class="mt-4">
                        <canvas id="img-canvas" class="img-canvas-preview"></canvas>
                    </div>
                    <div class="mt-4 bg-yellow-50 text-yellow-800 text-xs p-3 rounded-lg border border-yellow-100">
                        Proses berjalan 100% di browser kamu. Gambar tidak diupload ke server.
                    </div>
                </div>
            </section>

            <!-- RIGHT PANEL: SETTINGS -->
            <section class="it-panel p-0 shadow-sm h-fit">
                <div class="px-4 py-3 border-b border-gray-100 bg-gray-50">
                    <h2 class="font-semibold text-gray-700">Pengaturan</h2>
                </div>
                <div class="p-5 space-y-5">
                    
                    <!-- Text Input -->
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1 uppercase tracking-wide">Teks Watermark</label>
                        <input id="img-text" type="text" placeholder="WATERMARK DI SINI" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border transition duration-150">
                    </div>

                    <!-- Row 1 -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Opacity (0-100)</label>
                            <input id="img-opacity" type="number" min="0" max="100" value="20" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Warna</label>
                            <div class="flex items-center gap-2">
                                <input id="img-color" type="color" value="#808080" class="h-10 w-10 p-0 border-0 rounded overflow-hidden cursor-pointer shadow-sm">
                                <span class="text-xs text-gray-400">Pilih warna</span>
                            </div>
                        </div>
                    </div>

                    <!-- Row 2 -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Ukuran Font (px)</label>
                            <input id="img-size" type="number" min="8" max="500" value="54" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Rotasi (Derajat)</label>
                            <input id="img-angle" type="number" min="-360" max="360" value="45" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                        </div>
                    </div>

                    <!-- Row 3 -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Pola</label>
                            <select id="img-repeat" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border bg-white">
                                <option value="tile">Berulang (Tile)</option>
                                <option value="single">Satu Teks (Center)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Font</label>
                            <select id="img-font" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border bg-white">
                                <option value="system-ui">System Default</option>
                                <option value="Arial">Arial</option>
                                <option value="Times New Roman">Times New Roman</option>
                                <option value="Courier New">Courier New</option>
                                <option value="Verdana">Verdana</option>
                                <option value="Impact">Impact</option>
                            </select>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="pt-4 border-t border-gray-100 flex gap-3">
                        <button id="img-btn-reset" class="px-4 py-2 rounded-lg text-sm text-gray-600 bg-gray-100 hover:bg-gray-200 transition">Reset</button>
                        <div class="flex-grow"></div>
                        <button id="img-dl-jpg" disabled class="px-4 py-2 rounded-lg text-sm text-white bg-blue-600 hover:bg-blue-700 transition shadow-sm disabled:opacity-50 disabled:cursor-not-allowed">Download JPG</button>
                        <button id="img-dl-png" disabled class="px-4 py-2 rounded-lg text-sm text-white bg-indigo-600 hover:bg-indigo-700 transition shadow-sm disabled:opacity-50 disabled:cursor-not-allowed">Download PNG</button>
                    </div>

                </div>
            </section>
        </div>


        <!-- ========================================== -->
        <!-- TAB 2: PDF WATERMARK CONTENT (REFACTORED) -->
        <!-- ========================================== -->
        <div id="tab-content-pdf" class="hidden img-tool-theme grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- LEFT PANEL: PREVIEW -->
            <section class="it-panel p-0 overflow-hidden shadow-sm h-fit">
                <div class="px-4 py-3 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                    <h2 class="font-semibold text-gray-700">Pratinjau PDF</h2>
                    <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded border border-green-200">Secure Client-Side</span>
                </div>
                
                <div class="p-4">
                    <!-- Dropzone dengan style .it-drop (sama seperti Image) -->
                    <div id="pdf-dropzone" class="it-drop cursor-pointer hover:bg-gray-100">
                        <svg class="w-10 h-10 text-gray-400 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                        </svg>
                        <p class="text-sm text-gray-600">Klik atau drop file PDF di sini</p>
                        <input type="file" id="pdf-file" accept="application/pdf" hidden>
                    </div>

                    <!-- Password Protected Section -->
                    <div id="pdf-password-section" class="hidden mt-4 max-w-sm mx-auto bg-white p-3 rounded-lg shadow-sm border border-red-100">
                        <label class="block text-xs font-medium text-gray-700 mb-2">Dokumen terproteksi password</label>
                        <div class="flex gap-2">
                            <input type="password" id="pdf-password-input" placeholder="Password PDF..." class="flex-1 rounded-lg border-gray-300 border p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                            <button id="pdf-btn-unlock" class="bg-red-500 text-white px-3 py-1.5 rounded-lg text-xs font-medium hover:bg-red-600">Buka</button>
                        </div>
                        <p id="pdf-password-error" class="text-xs text-red-500 mt-1 hidden">Password salah.</p>
                    </div>

                    <!-- Preview Area -->
                    <div class="mt-4">
                        <div id="pdf-preview-area">
                            <p id="pdf-msg-empty" class="text-gray-400 text-sm">Pratinjau halaman pertama akan muncul di sini</p>
                        </div>
                    </div>
                    
                    <div class="mt-4 bg-yellow-50 text-yellow-800 text-xs p-3 rounded-lg border border-yellow-100">
                        File PDF diproses lokal di browser. Tidak ada data yang dikirim ke server.
                    </div>
                </div>
            </section>

            <!-- RIGHT PANEL: SETTINGS -->
            <section class="it-panel p-0 shadow-sm h-fit">
                <div class="px-4 py-3 border-b border-gray-100 bg-gray-50">
                    <h2 class="font-semibold text-gray-700">Pengaturan</h2>
                </div>
                
                <div class="p-5 space-y-5">
                    
                    <!-- Text Input -->
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1 uppercase tracking-wide">Teks Watermark</label>
                        <input id="pdf-text" type="text" placeholder="WATERMARK DI SINI" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border transition duration-150">
                    </div>

                    <!-- Row 1 -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Opacity (0-100)</label>
                            <input id="pdf-opacity" type="number" min="0" max="100" value="20" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Warna</label>
                            <div class="flex items-center gap-2">
                                <input id="pdf-color" type="color" value="#808080" class="h-10 w-10 p-0 border-0 rounded overflow-hidden cursor-pointer shadow-sm">
                                <span class="text-xs text-gray-400">Pilih warna</span>
                            </div>
                        </div>
                    </div>

                    <!-- Row 2 -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Ukuran Font (px)</label>
                            <input id="pdf-size" type="number" value="54" min="8" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Rotasi (Derajat)</label>
                            <input id="pdf-angle" type="number" value="45" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                        </div>
                    </div>

                    <!-- Row 3 -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Pola</label>
                            <select id="pdf-pattern" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border bg-white">
                                <option value="tile">Berulang (Tile)</option>
                                <option value="single">Satu Teks (Center)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Font</label>
                            <select id="pdf-font" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border bg-white">
                                <option value="Helvetica">System Default</option>
                                <option value="TimesRoman">Times Roman</option>
                                <option value="Courier">Courier</option>
                            </select>
                        </div>
                    </div>

                    <!-- Password Output Option (Kept small but aligned) -->
                    <div class="pt-4 border-t border-gray-100">
                        <div class="flex items-center gap-2 mb-2">
                            <input type="checkbox" id="pdf-chk-pass" class="rounded text-blue-600 focus:ring-blue-500 border-gray-300">
                            <label for="pdf-chk-pass" class="text-xs text-gray-600 font-medium">Set Password Output</label>
                        </div>
                        <input type="password" id="pdf-out-pass" placeholder="Password untuk file hasil..." class="hidden w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border text-sm">
                    </div>

                    <!-- Actions (Updated to Match Image Style) -->
                    <div class="pt-2 flex gap-3">
                        <!-- Reset Button Added -->
                        <button id="pdf-btn-reset" class="px-4 py-2 rounded-lg text-sm text-gray-600 bg-gray-100 hover:bg-gray-200 transition">Reset</button>
                        
                        <div class="flex-grow"></div>
                        
                        <!-- Download Button Aligned Right -->
                        <button id="pdf-btn-download" disabled class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-sm hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed text-sm">
                            Download PDF
                        </button>
                    </div>
                    
                    <!-- Loading Indicator -->
                    <div id="pdf-loading" class="hidden mt-2 p-2 bg-yellow-50 text-yellow-700 rounded-lg text-xs text-center border border-yellow-200 flex justify-center items-center">
                        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-yellow-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Sedang memproses...
                    </div>

                </div>
            </section>
        </div>

    </main>

    <footer class="bg-white border-t mt-auto py-6">
        <div class="max-w-7xl mx-auto px-4 text-center text-gray-500 text-sm">
            <p>&copy; 2024 Tandain. Runs entirely in your browser.</p>
        </div>
    </footer>

    <!-- LOGIC SCRIPTS -->
    <script>
        // === GLOBAL TAB LOGIC ===
        function switchTab(tabName) {
            // Hide all contents
            document.getElementById('tab-content-image').classList.add('hidden');
            document.getElementById('tab-content-pdf').classList.add('hidden');
            
            // Deactivate all buttons
            document.getElementById('tab-btn-image').classList.remove('active');
            document.getElementById('tab-btn-pdf').classList.remove('active');
            
            // Activate selected
            document.getElementById(`tab-content-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-btn-${tabName}`).classList.add('active');
        }

        
        // ==========================================
        // 1. IMAGE WATERMARK LOGIC
        // ==========================================
        (function() {
            const st = { img:null };
            const cv = document.getElementById('img-canvas');
            const ctx = cv.getContext('2d');

            const ids = ['img-file','img-drop','img-text','img-opacity','img-color','img-size','img-angle','img-repeat','img-font','img-btn-reset','img-dl-png','img-dl-jpg','img-meta'];
            const el = {}; ids.forEach(id => el[id] = document.getElementById(id));

            function clamp(v,min,max){return Math.max(min,Math.min(max,v));}
            function loadImage(file){
                return new Promise((resolve,reject)=>{
                    const url = URL.createObjectURL(file);
                    const img = new Image();
                    img.onload = ()=>{ URL.revokeObjectURL(url); resolve(img) };
                    img.onerror = reject; img.src = url;
                });
            }

            function computeBaseSide(textStr, fontPx, angleRad){
                ctx.save(); ctx.font = fontPx + 'px ' + el['img-font'].value;
                const m = ctx.measureText(textStr);
                const textW = Math.max(1, m.width);
                const textH = Math.max(1, (m.actualBoundingBoxAscent || fontPx*0.8) + (m.actualBoundingBoxDescent || fontPx*0.2));
                ctx.restore();
                const cos = Math.abs(Math.cos(angleRad)), sin = Math.abs(Math.sin(angleRad));
                const rotW = textW * cos + textH * sin;
                const rotH = textW * sin + textH * cos;
                return Math.ceil(Math.max(rotW, rotH) + Math.max(12, Math.round(fontPx * 0.5)));
            }

            function draw(){
                if(!st.img){ ctx.clearRect(0,0,cv.width,cv.height); return; }
                const W = st.img.naturalWidth, H = st.img.naturalHeight;
                cv.width = W; cv.height = H;
                ctx.clearRect(0,0,W,H);
                ctx.drawImage(st.img,0,0,W,H);

                // Use value OR placeholder as fallback for preview
                const t = el['img-text'].value || 'WATERMARK DI SINI';
                if(!t) return;
                
                const angleVal = parseFloat(el['img-angle'].value)||0;
                const a = angleVal * Math.PI/180;
                const op = clamp(parseInt(el['img-opacity'].value||20,10),0,100)/100;
                const fs = clamp(parseInt(el['img-size'].value||54,10),8,2048);
                const fontName = el['img-font'].value;
                const col = el['img-color'].value;

                if(el['img-repeat'].value === 'tile'){
                    const step = computeBaseSide(t, fs, a);
                    const tile = document.createElement('canvas');
                    tile.width = tile.height = step;
                    const tctx = tile.getContext('2d');
                    tctx.translate(step/2, step/2);
                    tctx.rotate(a);
                    tctx.fillStyle = col;
                    tctx.globalAlpha = op;
                    tctx.font = fs + 'px ' + fontName;
                    tctx.textAlign = 'center';
                    tctx.textBaseline = 'middle';
                    tctx.fillText(t,0,0);
                    const pat = ctx.createPattern(tile,'repeat');
                    ctx.fillStyle = pat; ctx.fillRect(0,0,W,H);
                } else {
                    ctx.save(); ctx.translate(W/2,H/2); ctx.rotate(a);
                    ctx.globalAlpha = op; ctx.fillStyle = col;
                    ctx.font = fs + 'px ' + fontName;
                    ctx.textAlign='center'; ctx.textBaseline='middle';
                    ctx.fillText(t,0,0); ctx.restore();
                }
            }

            // Event Listeners
            ['input','change'].forEach(ev=>{
                ['img-text','img-opacity','img-size','img-angle','img-color','img-repeat','img-font'].forEach(id=>{
                    el[id].addEventListener(ev, draw);
                });
            });

            // File Handlers
            el['img-drop'].onclick = ()=> el['img-file'].click();
            el['img-file'].onchange = async()=>{ if(el['img-file'].files[0]) await handleFile(el['img-file'].files[0]); };
            
            el['img-drop'].addEventListener('dragover', e=>{e.preventDefault(); el['img-drop'].classList.add('drag');});
            el['img-drop'].addEventListener('dragleave', ()=> el['img-drop'].classList.remove('drag'));
            el['img-drop'].addEventListener('drop', async e=>{ 
                e.preventDefault(); el['img-drop'].classList.remove('drag'); 
                const f=e.dataTransfer.files&&e.dataTransfer.files[0]; 
                if(f) await handleFile(f); 
            });

            async function handleFile(f){
                if(!f.type.startsWith('image/')) return alert('File harus gambar.');
                const img = await loadImage(f); st.img=img; draw();
                el['img-dl-png'].disabled = el['img-dl-jpg'].disabled = false;
                el['img-meta'].textContent=`${img.naturalWidth}×${img.naturalHeight}px`;
            }

            el['img-dl-png'].onclick=()=>{if(!st.img)return; const a=document.createElement('a');a.download='watermarked.png';a.href=cv.toDataURL('image/png');a.click();};
            el['img-dl-jpg'].onclick=()=>{if(!st.img)return; const a=document.createElement('a');a.download='watermarked.jpg';a.href=cv.toDataURL('image/jpeg',0.92);a.click();};

            el['img-btn-reset'].onclick = ()=>{
                st.img=null; cv.width=300; cv.height=150; 
                el['img-dl-png'].disabled=el['img-dl-jpg'].disabled=true;
                el['img-meta'].textContent=''; el['img-text'].value=''; // Value reset to empty
                el['img-opacity'].value=20; el['img-color'].value='#808080'; // New Defaults
                el['img-size'].value=54; el['img-angle'].value=45;
                draw();
            };
            
            // Init blank canvas styling
            el['img-btn-reset'].click();
        })();


        // ==========================================
        // 2. PDF WATERMARK LOGIC (REVISED)
        // ==========================================
        (function() {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.worker.min.js';
            const { PDFDocument, rgb, degrees } = PDFLib;

            let uploadedBytes = null;
            let watermarkedBytes = null;
            let currentName = 'document.pdf';
            let debounceTimer = null; // Fix: Debounce

            // UI Elements
            const ids = {
                drop: 'pdf-dropzone',
                file: 'pdf-file',
                preview: 'pdf-preview-area',
                dlBtn: 'pdf-btn-download',
                resetBtn: 'pdf-btn-reset',
                text: 'pdf-text',
                opacity: 'pdf-opacity',
                color: 'pdf-color',
                size: 'pdf-size',
                angle: 'pdf-angle',
                pattern: 'pdf-pattern',
                font: 'pdf-font',
                chkPass: 'pdf-chk-pass',
                outPass: 'pdf-out-pass',
                passSec: 'pdf-password-section',
                passIn: 'pdf-password-input',
                passBtn: 'pdf-btn-unlock',
                loading: 'pdf-loading',
                passErr: 'pdf-password-error'
            };
            const ui = {}; Object.keys(ids).forEach(k => ui[k] = document.getElementById(ids[k]));

            // Helper
            function hexToRgb(hex) {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? { r: parseInt(result[1], 16)/255, g: parseInt(result[2], 16)/255, b: parseInt(result[3], 16)/255 } : { r:0, g:0, b:0 };
            }

            // Trigger wrapper with debounce to prevent crashing on rapid input changes
            function triggerWatermarkUpdate() {
                if(debounceTimer) clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    if(uploadedBytes) applyWatermark();
                }, 300); // 300ms delay
            }

            // Core Logic
            async function applyWatermark(fileBytes = uploadedBytes, password = null) {
                if (!fileBytes) return;
                
                ui.loading.classList.remove('hidden');
                ui.dlBtn.disabled = true;
                
                try {
                    // Reset previous result to avoid stale data
                    watermarkedBytes = null;

                    // Load Doc
                    let pdfDoc;
                    try {
                        const opts = password ? { password } : {};
                        pdfDoc = await PDFDocument.load(fileBytes, opts);
                        ui.passSec.classList.add('hidden');
                        ui.passErr.classList.add('hidden');
                    } catch (e) {
                        if (e.message.includes('encrypted')) {
                            ui.passSec.classList.remove('hidden');
                            if(password) ui.passErr.classList.remove('hidden');
                            throw new Error('Encrypted');
                        }
                        throw e;
                    }

                    // Params
                    const textStr = ui.text.value || 'WATERMARK DI SINI';
                    const opacityVal = parseInt(ui.opacity.value || 20) / 100;
                    const colorVal = hexToRgb(ui.color.value);
                    const sizeVal = parseInt(ui.size.value || 50);
                    const angleVal = parseInt(ui.angle.value || 45);
                    const fontName = ui.font.value;

                    // Font
                    let customFont;
                    if(fontName === 'TimesRoman') customFont = await pdfDoc.embedFont(PDFLib.StandardFonts.TimesRoman);
                    else if(fontName === 'Courier') customFont = await pdfDoc.embedFont(PDFLib.StandardFonts.Courier);
                    else customFont = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);

                    // Draw
                    const pages = pdfDoc.getPages();
                    pages.forEach(page => {
                        const { width, height } = page.getSize();
                        const textWidth = customFont.widthOfTextAtSize(textStr, sizeVal);
                        const textHeight = sizeVal; 
                        const cx = width/2, cy = height/2;

                        if (ui.pattern.value === 'single') {
                            page.drawText(textStr, {
                                x: cx - textWidth/2, y: cy - textHeight/2,
                                size: sizeVal, font: customFont,
                                color: rgb(colorVal.r, colorVal.g, colorVal.b),
                                opacity: opacityVal,
                                rotate: degrees(angleVal)
                            });
                        } else {
                            // Tile logic: Grid Based (Diagonal Coverage)
                            // Use diagonal to ensure coverage even when rotated
                            const diag = Math.sqrt(width*width + height*height);
                            
                            // Safe gap calculation
                            // Horizontal Gap: Text width + a fraction of font size
                            const xGap = textWidth + (sizeVal * 0.5); 
                            
                            // Vertical Gap: Font Size * 2 (as requested "jangan tumpuk2")
                            const yGap = sizeVal * 2;
                            
                            // Determine range relative to center
                            // Go from -diag to +diag to cover everything
                            const limit = diag;
                            
                            // Loop for drawing
                            for (let y = -limit; y <= limit; y += yGap) {
                                for (let x = -limit; x <= limit; x += xGap) {
                                    page.drawText(textStr, {
                                        x: cx + x, // Center offset
                                        y: cy + y,
                                        size: sizeVal,
                                        font: customFont,
                                        color: rgb(colorVal.r, colorVal.g, colorVal.b),
                                        opacity: opacityVal,
                                        rotate: degrees(angleVal)
                                    });
                                }
                            }
                        }
                    });

                    // Save
                    const saveOpts = {};
                    if(ui.chkPass.checked && ui.outPass.value) {
                        saveOpts.userPassword = ui.outPass.value;
                        saveOpts.ownerPassword = ui.outPass.value;
                    }
                    watermarkedBytes = await pdfDoc.save(saveOpts);

                    // Render Preview
                    await renderPreview(watermarkedBytes);

                    // Enable DL
                    ui.dlBtn.disabled = false;

                } catch (err) {
                    if(err.message !== 'Encrypted') console.error(err);
                } finally {
                    ui.loading.classList.add('hidden');
                }
            }

            async function renderPreview(pdfBytes) {
                ui.preview.innerHTML = '';
                try {
                    const loadingTask = pdfjsLib.getDocument({ data: pdfBytes });
                    const pdf = await loadingTask.promise;
                    const page = await pdf.getPage(1);
                    
                    const viewport = page.getViewport({ scale: 1 });
                    const containerWidth = ui.preview.clientWidth > 0 ? ui.preview.clientWidth : 300;
                    const scale = (containerWidth - 32) / viewport.width;
                    const scaledViewport = page.getViewport({ scale: scale });

                    const cvs = document.createElement('canvas');
                    cvs.height = scaledViewport.height;
                    cvs.width = scaledViewport.width;
                    
                    await page.render({ canvasContext: cvs.getContext('2d'), viewport: scaledViewport }).promise;
                    ui.preview.appendChild(cvs);
                    
                    if(pdf.numPages > 1) {
                        const info = document.createElement('p');
                        info.className = 'text-xs text-gray-500 mt-2 bg-white px-2 py-1 rounded shadow-sm border';
                        info.textContent = `+ ${pdf.numPages - 1} halaman lainnya`;
                        ui.preview.appendChild(info);
                    }
                } catch(e) { console.error(e); }
            }

            // Events
            ui.file.addEventListener('change', e => {
                const f = e.target.files[0];
                if(f && f.type === 'application/pdf') {
                    currentName = f.name.replace('.pdf','-watermark.pdf');
                    const r = new FileReader();
                    r.onload = ev => { uploadedBytes = ev.target.result; applyWatermark(); };
                    r.readAsArrayBuffer(f);
                }
            });

            ui.drop.addEventListener('dragover', e=>{ e.preventDefault(); ui.drop.classList.add('drag'); });
            ui.drop.addEventListener('dragleave', ()=> ui.drop.classList.remove('drag'));
            ui.drop.addEventListener('drop', e=>{
                e.preventDefault(); ui.drop.classList.remove('drag');
                const f = e.dataTransfer.files[0];
                if(f && f.type==='application/pdf'){ ui.file.files = e.dataTransfer.files; ui.file.dispatchEvent(new Event('change')); }
            });

            // Use debounce for inputs
            ['input','change'].forEach(ev => {
                [ui.text, ui.opacity, ui.color, ui.size, ui.angle, ui.pattern, ui.font].forEach(elm => {
                    elm.addEventListener(ev, triggerWatermarkUpdate);
                });
            });

            // Password output toggle
            ui.chkPass.addEventListener('change', () => {
                if(ui.chkPass.checked) ui.outPass.classList.remove('hidden');
                else ui.outPass.classList.add('hidden');
                triggerWatermarkUpdate();
            });

            // Reset
            ui.resetBtn.addEventListener('click', () => {
                ui.text.value = '';
                ui.opacity.value = 20;
                ui.color.value = '#808080';
                ui.size.value = 54;
                ui.angle.value = 45;
                ui.pattern.value = 'tile';
                ui.font.value = 'Helvetica';
                triggerWatermarkUpdate();
            });

            // Unlock
            ui.passBtn.addEventListener('click', () => applyWatermark(uploadedBytes, ui.passIn.value));

            // Download Fix (Append to body)
            ui.dlBtn.addEventListener('click', () => {
                if(!watermarkedBytes) return;
                const blob = new Blob([watermarkedBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = currentName;
                document.body.appendChild(link); // Required for Firefox/some browsers
                link.click();
                document.body.removeChild(link);
                setTimeout(() => URL.revokeObjectURL(url), 100);
            });

        })();
    </script>
</body>
</html>
